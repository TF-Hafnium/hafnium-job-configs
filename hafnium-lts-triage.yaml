- job:
    name: hafnium-lts-triage
    node: docker-amd64-hafnium-noble
    project-type: freestyle
    concurrent: true
    disabled: false
    defaults: global
    description: |
      Generate LTS triage report every Friday
    properties:
      - build-discarder:
          days-to-keep: 45
          num-to-keep: 200
          artifact-num-to-keep: 100
    parameters:
      - string:
          name: HAFNIUM_REPO
          default: https://review.trustedfirmware.org/hafnium/hafnium
          description: The hafnium repo to clone from
      - string:
          name: LTS_BRANCHES
          default: lts-v2.14
          description: |
            LTS branches
    scm:
      - git:
          url: https://review.trustedfirmware.org/ci/hafnium-job-configs
          branches:
            - master
          skip-tag: true
          wipe-workspace: true
    triggers:
      - timed: H 5 * * 5 # Run the job at 00:00 every Friday @CTS timezone
    wrappers:
      - timestamps
      - timeout:
          timeout: 30
          fail: true
      - credentials-binding:
          - ssh-user-private-key:
              credential-id: TFA_CI_BOT_USER_SSH_KEY
              key-file-variable: CI_BOT_KEY
              username-variable: CI_BOT_USERNAME
              passphrase-variable: ""
    builders:
      - shell: |
          #!/bin/bash
          set -ex

          DATE=$(date +'%Y-%m-%d')
          START_PATH=$(pwd)
          LTS_TMP_DIR=$(mktemp -d -p ./)
          cd $LTS_TMP_DIR

          HAFNIUM_TMP_DIR=$(mktemp -d -p ./)
          cd ${{HAFNIUM_TMP_DIR}}
          git clone ${{HAFNIUM_REPO}} -b master ./
          LTS_REPO_PATH=$(pwd)
          cd -
          for b in ${{LTS_BRANCHES}};
          do
              CSV_REPORT="${{b}}_${{DATE}}.csv"
              git -C ${{LTS_REPO_PATH}} checkout -b ${{b}} origin/${{b}}

              python3 ${{START_PATH}}/script/hafnium-lts-triage.py --repo ${{LTS_REPO_PATH}} --csv_path ${{START_PATH}}/${{CSV_REPORT}} \
              --lts ${{b}} --gerrit_user ${{CI_BOT_USERNAME}} --ssh_keyfile ${{CI_BOT_KEY}} --debug
              [ -f "${{START_PATH}}/${{CSV_REPORT}}" ] && echo "${{CSV_REPORT}}" >> ${{START_PATH}}/got_report.txt
          done

          cd ${{START_PATH}}
          rm -rf ${{LTS_TMP_DIR}}
    publishers:
      - conditional-publisher:
          - condition-kind: file-exists
            on-evaluation-failure: dont-run
            condition-filename: got_report.txt
            condition-basedir: workspace
            action:
              - archive:
                  artifacts: '*.csv'
              - email-ext:
                  always: true
                  recipients: arthur.she@linaro.org, madhukar.pappireddy@arm.com, bipin.ravi@arm.com, vwadekar@nvidia.com, joanna.farley@arm.com, lauren.wehrmeister@arm.com, yann.gautier@st.com, jidong@google.com, olivier.deprez@arm.com, Govindraj.Raja@arm.com
                  subject: Hafnium LTS Triage report
                  body: Attached is the CSV report from the Hafnium LTS Triage job this week.
                  attachments: '*.csv'

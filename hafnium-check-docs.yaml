- job:
    name: hafnium-check-docs
    display-name: 'Hafnium Check-Docs'
    description: Build docs for hafnium
    project-type: freestyle
    node: docker-amd64-hafnium-noble
    defaults: global
    disabled: false
    concurrent: true

    properties:
      - build-discarder:
          days-to-keep: 30
          num-to-keep: 30

    parameters:
      - string:
          name: GERRIT_PROJECT
          description: 'Gerrit project name (repo path)'
          default: 'hafnium/hafnium'
      - string:
          name: GERRIT_BRANCH
          description: 'Branch to check out'
          default: 'master'
      - string:
          name: GERRIT_REFSPEC
          description: 'Git refspec to fetch (Gerrit patchset or manual refspec)'
          default: '+refs/heads/master:refs/remotes/origin/master'
      # Docs job needs a base branch to detect whether "docs/" changed.
      - string:
          name: REFNAME_BASE
          description: 'Base branch ref to compare against'
          default: 'origin/master'

    scm:
      - git:
          url: https://review.trustedfirmware.org/${{GERRIT_PROJECT}}
          refspec: ${{GERRIT_REFSPEC}}
          name: origin
          branches:
            - ${{GERRIT_BRANCH}}
          skip-tag: true
          shallow-clone: false
          wipe-workspace: true
          submodule:
            recursive: true

    triggers:
      - gerrit:
          server-name: review.trustedfirmware.org
          override-votes: true
          gerrit-build-successful-verified-value: 1
          gerrit-build-failed-verified-value: -1
          gerrit-build-successful-codereview-value: 0
          gerrit-build-failed-codereview-value: 0
          trigger-on:
            - comment-added-event:
                approval-category: Allow-CI
                approval-value: 1
          projects:
            - project-compare-type: PLAIN
              project-pattern: hafnium/hafnium
              branches:
                - branch-compare-type: PLAIN
                  branch-pattern: master

    wrappers:
      - timestamps
      - timeout:
          timeout: 30
          fail: true
      - build-name:
          name: '#${{BUILD_NUMBER}}-${{GIT_REVISION,length=8}}'
      - workspace-cleanup
      - inject:
          properties-content: |
            LANG=C.UTF-8
            LC_ALL=C.UTF-8
            PYTHONIOENCODING=UTF-8

    builders:
      - shell: |
          #!/bin/bash
          set -euo pipefail
          set -x

          # 1) Ensure all remote origin/ branches exist
          git fetch --no-tags "https://review.trustedfirmware.org/${{GERRIT_PROJECT}}" \
            '+refs/heads/*:refs/remotes/origin/*'

          # 2) Select correct refspec:
          #  - In Gerrit CI → use GERRIT_REFSPEC injected by Gerrit.
          #  - Manual run   → use the parameter default or user-entered value.
          FETCH_SPEC="${{GERRIT_REFSPEC}}"

          # 3) Fetch and checkout the target commit/patchset
          git fetch --no-tags "https://review.trustedfirmware.org/${{GERRIT_PROJECT}}" "${{FETCH_SPEC}}"
          git checkout -qf FETCH_HEAD

          echo "HEAD: $(git rev-parse --short HEAD)"
          echo "BASE: ${{REFNAME_BASE}}"

          # 4) Find merge-base between HEAD and the base branch
          merge_base="$(git merge-base "${{REFNAME_BASE}}" HEAD)"
          echo "merge-base: ${{merge_base}}"

          # 5) Detect whether any docs/ files changed.
          # Only build if something under docs/ changed.If not, skip the build entirely.
          if ! git diff --name-only "${{merge_base}}..HEAD" -- docs/ | grep -q .; then
            echo "[docs] No changes under docs/ - skipping (success)."
            exit 0
          fi
          echo "[docs] Changes under docs/detected - building..."

          # 6) Install docs dependencies in Poetry venv
          poetry -C "$PWD" install --no-root --with docs

          # 7) Build docs
          poetry run make doc

          echo "[docs] Build completed."

    publishers:
      - conditional-publisher:
          - condition-kind: file-exists
            condition-filename: docs/build/html/index.html
            action:
              - archive:
                  artifacts: 'docs/build/html/**'
                  only-if-success: true
                  fingerprint: true

- job:
    name: hafnium-commitlint
    description: Lint Hafnium commit messages (merge-base(REFNAME_BASE, HEAD)..HEAD)
    project-type: freestyle
    node: docker-amd64-hafnium-noble
    display-name: 'Hafnium Commitlint'
    defaults: global
    disabled: false
    concurrent: true

    properties:
      - build-discarder:
          days-to-keep: 30
          num-to-keep: 30

    parameters:
      # NOTE:
      # `GERRIT_BRANCH` is used by the SCM configuration to determine what Jenkins
      # checks out (and is required for manual runs where Gerrit variables are absent).
      # `REFNAME_BASE` is used only by the commitlint logic to compute the
      # merge-base for the commit range.
      #
      # Although the defaults often align (master / origin/master), these serve
      # different purposes and are intentionally kept separate to support manual
      # runs, backports, and future non-master branches.
      - string:
          name: GERRIT_PROJECT
          description: 'Gerrit project name (repo path)'
          default: 'hafnium/hafnium'
      - string:
          name: GERRIT_BRANCH
          description: 'Branch used for SCM checkout (independent of commitlint base)'
          default: 'master'
      - string:
          name: GERRIT_REFSPEC
          description: 'Git refspec to fetch (Gerrit patchset or manual refspec)'
          default: '+refs/heads/master:refs/remotes/origin/master'
      - string:
          name: REFNAME_BASE
          description: 'Base branch ref to compare against'
          default: 'origin/master'

    scm:
        - git:
            url: https://review.trustedfirmware.org/${GERRIT_PROJECT}
            refspec: ${GERRIT_REFSPEC}
            name: origin
            branches:
                - ${GERRIT_BRANCH}
            skip-tag: true
            depth: 100
            shallow-clone: false
            wipe-workspace: false
            submodule:
                recursive: true

    triggers:
      - gerrit:
          server-name: 'review.trustedfirmware.org'
          override-votes: true
          gerrit-build-successful-verified-value: 1
          gerrit-build-failed-verified-value: -1
          gerrit-build-successful-codereview-value: 0
          gerrit-build-failed-codereview-value: 0
          trigger-on:
            - comment-added-event:
                approval-category: 'Allow-CI'
                approval-value: '1'
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'hafnium/hafnium'
              branches:
                - branch-compare-type: PLAIN
                  branch-pattern: 'master'

    wrappers:
        - timestamps
        - timeout:
            timeout: 30
            fail: true
        - build-name:
            name: '#${BUILD_NUMBER}-${GIT_REVISION,length=8}'

    builders:
      - shell: |
          #!/bin/bash
          set -euo pipefail
          set -x

          # Ensure all heads (incl. REFNAME_BASE) exist locally.
          git fetch --no-tags "https://review.trustedfirmware.org/${GERRIT_PROJECT}" \
            '+refs/heads/*:refs/remotes/origin/*'

          # Select fetch spec:
          # - CI: use Gerrit-provided GERRIT_REFSPEC
          # - Manual: use the parameter entered in Jenkins UI
          FETCH_SPEC="${GERRIT_REFSPEC}"

          # Fetch the target commit/patchset and check out FETCH_HEAD
          git fetch --no-tags "https://review.trustedfirmware.org/${GERRIT_PROJECT}" "${FETCH_SPEC}"
          git checkout -qf FETCH_HEAD

          echo "HEAD: $(git rev-parse --short HEAD)"
          echo "BASE: ${REFNAME_BASE}"

          # Compute merge-base with the base branch
          merge_base="$(git merge-base "${REFNAME_BASE}" HEAD)"
          echo "Computed merge-base: ${merge_base}"

          echo "Lint range: ${merge_base}..HEAD"
          git log --oneline "${merge_base}..HEAD" || true

          # If no commits ahead, exit cleanly.
          if [[ "$(git rev-list --count "${merge_base}..HEAD")" -eq 0 ]]; then
            echo "No new commits to lint (range empty)."
            exit 0
          fi

          # Perform commitlint for each commit.
          # Lint the computed range (merge_base..HEAD) using Hafnium's make target.
          # For readability, insert a blank line after each commit's result line.
          make commitlint COMMITLINT_FROM="${merge_base}" COMMITLINT_TO="HEAD" \
            | awk '{
                print;
                if ($0 ~ /found[[:space:]]+[0-9]+[[:space:]]+problems?/) print "";
              }'

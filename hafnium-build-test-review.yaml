- job:
    name: hafnium-build-test-review
    project-type: freestyle
    defaults: global
    properties:
      - build-discarder:
          days-to-keep: 90
          nums-to-keep: 90
    disabled: false
    node: docker-amd64-xenial
    display-name: 'Hafnium builder'
    triggers:
      - gerrit:
          server-name: 'review.trustedfirmware.org'
          trigger-on:
            - patchset-created-event
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'hafnium/hafnium'
              branches:
                - branch-pattern: 'master'
    wrappers:
      - timestamps
    builders:
      - shell: |
          #!/bin/bash

          set -xe

          HAFNIUM_BUILD_DIR="${WORKSPACE}/hafnium"

          if [[ -e "${HAFNIUM_BUILD_DIR}/.git" ]]; then
            # If the repository exists make sure it is clean.
            cd "${HAFNIUM_BUILD_DIR}"
            git clean -fd
            git reset --hard
            # Update the submodules.
            git submodule update
          else
            # If it does not exist clone it.
            rm -rf "${HAFNIUM_BUILD_DIR}"
            git clone --recurse-submodules "https://review.trustedfirmware.org/hafnium/hafnium" \
                      "${HAFNIUM_BUILD_DIR}"
            cd "${HAFNIUM_BUILD_DIR}"
          fi

          # Try to apply patch.
          if ! { git fetch "http://${GERRIT_HOST}/${GERRIT_PROJECT}" "${GERRIT_REFSPEC}" &&
                git checkout FETCH_HEAD; }; then
            git reset --hard
            echo "Applying patch FAILED"
            exit 1
          fi

          kokoro/build.sh
